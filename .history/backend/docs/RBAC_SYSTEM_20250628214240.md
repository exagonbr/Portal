# Sistema RBAC (Role-Based Access Control)

## Vis√£o Geral

O sistema de autentica√ß√£o foi atualizado para usar um modelo RBAC baseado nos campos booleanos existentes na tabela `users`, mantendo compatibilidade com a estrutura atual do banco de dados.

## Mapeamento de Roles Atual

### Campos Booleanos ‚Üí Roles RBAC

| Campo Booleano | Role RBAC | Nome Exibido | ID |
|----------------|-----------|--------------|-----|
| `is_admin` | `SYSTEM_ADMIN` | Administrador do Sistema | `system_admin` |
| `is_teacher` | `TEACHER` | Professor | `teacher` |
| `is_student` | `STUDENT` | Estudante | `student` |

## Permiss√µes por Role

### SYSTEM_ADMIN (Administrador do Sistema)
```typescript
permissions = [
  'system:admin',
  'users:create', 'users:read', 'users:update', 'users:delete',
  'institutions:create', 'institutions:read', 'institutions:update', 'institutions:delete',
  'courses:create', 'courses:read', 'courses:update', 'courses:delete',
  'content:create', 'content:read', 'content:update', 'content:delete',
  'analytics:read', 'system:settings', 'logs:read'
];
```

### TEACHER (Professor)
```typescript
permissions = [
  'courses:create', 'courses:read', 'courses:update',
  'content:create', 'content:read', 'content:update',
  'students:read', 'students:update',
  'assignments:create', 'assignments:read', 'assignments:update',
  'grades:create', 'grades:read', 'grades:update'
];
```

### STUDENT (Estudante)
```typescript
permissions = [
  'courses:read',
  'content:read',
  'assignments:read', 'assignments:submit',
  'grades:read',
  'profile:read', 'profile:update'
];
```

## Estrutura de Permiss√µes

As permiss√µes seguem o padr√£o `recurso:a√ß√£o`:

- **Recursos**: `system`, `users`, `institutions`, `courses`, `content`, `students`, `assignments`, `grades`, `profile`, `analytics`, `logs`
- **A√ß√µes**: `create`, `read`, `update`, `delete`, `admin`, `submit`, `settings`

## Implementa√ß√£o

### Localiza√ß√£o do C√≥digo
- **Arquivo Principal**: `backend/src/services/OptimizedAuthService.ts`
- **Fun√ß√µes Atualizadas**:
  - `login()` - Linha 94-147
  - `refreshAccessToken()` - Linha 367-396
  - `getUserById()` - Linha 431-460
  - `hasPermission()` - Linha 515-540

### Como Funciona

1. **Login**: O sistema verifica os campos booleanos (`is_admin`, `is_teacher`, `is_student`) e mapeia para o role RBAC correspondente
2. **Permiss√µes**: Cada role tem um conjunto espec√≠fico de permiss√µes definidas estaticamente
3. **Valida√ß√£o**: A fun√ß√£o `hasPermission()` verifica se o usu√°rio tem uma permiss√£o espec√≠fica baseada no seu role

## Adicionando Novos Roles

Para adicionar os novos roles mencionados (`INSTITUTION_MANAGER`, `COORDINATOR`, `GUARDIAN`), siga estes passos:

### 1. Adicionar Campos Booleanos na Tabela Users

```sql
ALTER TABLE users ADD COLUMN is_institution_manager BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN is_coordinator BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN is_guardian BOOLEAN DEFAULT FALSE;
```

### 2. Atualizar o Mapeamento de Roles

No arquivo `OptimizedAuthService.ts`, adicione os novos casos nas fun√ß√µes:

```typescript
// Exemplo para INSTITUTION_MANAGER
if (user.is_admin) {
  roleInfo = { name: 'Administrador do Sistema', slug: 'SYSTEM_ADMIN', id: 'system_admin' };
} else if (user.is_institution_manager) {
  roleInfo = { name: 'Gerente de Institui√ß√£o', slug: 'INSTITUTION_MANAGER', id: 'institution_manager' };
} else if (user.is_coordinator) {
  roleInfo = { name: 'Coordenador', slug: 'COORDINATOR', id: 'coordinator' };
} else if (user.is_guardian) {
  roleInfo = { name: 'Respons√°vel', slug: 'GUARDIAN', id: 'guardian' };
} else if (user.is_teacher) {
  roleInfo = { name: 'Professor', slug: 'TEACHER', id: 'teacher' };
} else if (user.is_student) {
  roleInfo = { name: 'Estudante', slug: 'STUDENT', id: 'student' };
}
```

### 3. Definir Permiss√µes para Novos Roles

```typescript
// INSTITUTION_MANAGER
if (user.is_institution_manager) {
  permissions = [
    'institution:admin',
    'users:create', 'users:read', 'users:update',
    'courses:create', 'courses:read', 'courses:update',
    'content:create', 'content:read', 'content:update',
    'analytics:read', 'reports:read'
  ];
}

// COORDINATOR
else if (user.is_coordinator) {
  permissions = [
    'courses:read', 'courses:update',
    'content:read', 'content:update',
    'students:read', 'students:update',
    'teachers:read',
    'reports:read'
  ];
}

// GUARDIAN
else if (user.is_guardian) {
  permissions = [
    'students:read',
    'courses:read',
    'grades:read',
    'assignments:read',
    'profile:read', 'profile:update'
  ];
}
```

### 4. Atualizar Todas as Fun√ß√µes

Certifique-se de atualizar o mapeamento em todas as fun√ß√µes:
- `login()`
- `refreshAccessToken()`
- `getUserById()`
- `hasPermission()`

## Vantagens desta Abordagem

1. **Compatibilidade**: Mant√©m a estrutura atual do banco de dados
2. **Flexibilidade**: F√°cil adi√ß√£o de novos roles
3. **Performance**: N√£o requer JOINs complexos
4. **Simplicidade**: L√≥gica clara e direta
5. **Escalabilidade**: Preparado para expans√£o futura

## Considera√ß√µes Futuras

- **Roles Din√¢micos**: Futuramente, pode-se migrar para um sistema de roles din√¢micos com tabelas separadas
- **Permiss√µes Granulares**: Adicionar permiss√µes mais espec√≠ficas conforme necess√°rio
- **Hierarquia de Roles**: Implementar heran√ßa de permiss√µes entre roles
- **Contexto Institucional**: Adicionar permiss√µes espec√≠ficas por institui√ß√£o

## Testando o Sistema

Para testar o sistema RBAC:

1. **Login**: Use as credenciais `sabercon@sabercon.com.br` / `admin123`
2. **Verificar Role**: O usu√°rio deve ser identificado como `SYSTEM_ADMIN`
3. **Verificar Permiss√µes**: O token JWT deve conter todas as permiss√µes de admin
4. **Testar Endpoints**: Verificar se os endpoints respeitam as permiss√µes

## Logs e Debugging

O sistema inclui logs detalhados para debugging:
- Login bem-sucedido com role e n√∫mero de permiss√µes
- Erros de autentica√ß√£o
- Valida√ß√£o de tokens
- Verifica√ß√£o de permiss√µes

```
‚úÖ Login bem-sucedido para: sabercon@sabercon.com.br (143ms)
üìä User role: SYSTEM_ADMIN, permissions: 20