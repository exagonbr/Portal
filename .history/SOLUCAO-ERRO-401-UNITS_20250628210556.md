# üîß Solu√ß√£o para Erro 401 na API /units

## üìã Problema Identificado

**Log do Erro:**
```
127.0.0.1 - - [28/Jun/2025:23:59:14 +0000] "GET /api/units?limit=100 HTTP/1.1" 401 44 "http://localhost:3000/admin/schools" "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:140.0) Gecko/20100101 Firefox/140.0"
```

**Causa Raiz:**
- ‚ùå `GOOGLE_CLIENT_SECRET` estava configurado com o mesmo valor do `GOOGLE_CLIENT_ID`
- ‚ùå Isso causava falha na autentica√ß√£o NextAuth Google OAuth
- ‚ùå A rota `/api/units` usa `getServerSession(authOptions)` que retornava `null`
- ‚ùå Resultado: erro 401 Unauthorized

## üîß Corre√ß√µes Implementadas

### 1. Corre√ß√£o da Configura√ß√£o OAuth (`.env`)
```diff
- GOOGLE_CLIENT_SECRET=1049786491633-bfgulpbk43kkpgjaub36rhmv4v9l0m0u.apps.googleusercontent.com
+ GOOGLE_CLIENT_SECRET=GOCSPX-PLACEHOLDER_SECRET_NEEDS_TO_BE_CONFIGURED
```

**‚ö†Ô∏è A√á√ÉO NECESS√ÅRIA:** Configure o `GOOGLE_CLIENT_SECRET` correto no Google Cloud Console.

### 2. Sistema de Debug de Autentica√ß√£o

#### Arquivo: `src/lib/auth-debug.ts`
- ‚úÖ Fun√ß√£o `debugAuthConfig()` para verificar configura√ß√£o
- ‚úÖ `authOptionsDebug` com logs detalhados
- ‚úÖ Provider de credenciais como fallback
- ‚úÖ Fun√ß√£o `testSession()` para diagn√≥stico

#### Arquivo: `src/app/api/debug/auth/route.ts`
- ‚úÖ Rota GET para diagn√≥stico completo
- ‚úÖ Rota POST para teste de login com credenciais
- ‚úÖ Verifica√ß√£o de cookies, headers e sess√µes

### 3. API de Debug para Units

#### Arquivo: `src/app/api/units-debug/route.ts`
- ‚úÖ Vers√£o da API `/units` com debug extensivo
- ‚úÖ Funciona mesmo sem autentica√ß√£o (retorna dados simulados)
- ‚úÖ Logs detalhados de cada etapa
- ‚úÖ Informa√ß√µes de debug na resposta

### 4. P√°gina de Teste

#### Arquivo: `test-auth-fix.html`
- ‚úÖ Interface web para testar todas as corre√ß√µes
- ‚úÖ Testes automatizados com resultados visuais
- ‚úÖ Diagn√≥stico completo da configura√ß√£o
- ‚úÖ Teste de login com credenciais

## üß™ Como Testar a Solu√ß√£o

### Op√ß√£o 1: P√°gina de Teste (Recomendado)
1. Abra `http://localhost:3000/test-auth-fix.html`
2. Execute todos os testes na sequ√™ncia
3. Verifique os resultados e taxa de sucesso

### Op√ß√£o 2: Testes Manuais via API

#### Teste 1: Diagn√≥stico de Configura√ß√£o
```bash
curl http://localhost:3000/api/debug/auth
```

#### Teste 2: API Units Original
```bash
curl http://localhost:3000/api/units?limit=100
```

#### Teste 3: API Units Debug
```bash
curl http://localhost:3000/api/units-debug?limit=100
```

#### Teste 4: Login com Credenciais
```bash
curl -X POST http://localhost:3000/api/debug/auth \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@sabercon.com.br","password":"admin123"}'
```

## üîç Diagn√≥stico Esperado

### ‚úÖ Cen√°rio de Sucesso
- Configura√ß√£o OAuth correta
- Sess√£o NextAuth v√°lida
- API `/units` retorna dados
- Status 200 em todas as requisi√ß√µes

### ‚ö†Ô∏è Cen√°rio Parcial (Sem OAuth)
- OAuth ainda n√£o configurado
- API `/units-debug` funciona com dados simulados
- Login com credenciais funciona
- Permite desenvolvimento sem Google OAuth

### ‚ùå Cen√°rio de Falha
- Configura√ß√£o ainda incorreta
- Erros 401 persistem
- Logs de debug mostram problemas espec√≠ficos

## üöÄ Pr√≥ximos Passos

### Imediato
1. **Configure o Google OAuth:**
   - Acesse [Google Cloud Console](https://console.cloud.google.com/)
   - V√° para "APIs & Services" > "Credentials"
   - Encontre o Client ID: `1049786491633-bfgulpbk43kkpgjaub36rhmv4v9l0m0u`
   - Copie o Client Secret correto
   - Atualize o arquivo `.env`

2. **Teste a Solu√ß√£o:**
   - Execute os testes na p√°gina `test-auth-fix.html`
   - Verifique se a API `/units` funciona
   - Confirme que n√£o h√° mais erros 401

### M√©dio Prazo
1. **Remover C√≥digo de Debug:**
   - Ap√≥s confirmar que tudo funciona
   - Remover arquivos `*-debug.ts` e `test-auth-fix.html`
   - Limpar logs de debug em produ√ß√£o

2. **Implementar Autentica√ß√£o Robusta:**
   - Adicionar refresh token autom√°tico
