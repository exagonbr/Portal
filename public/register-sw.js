// Script para registrar o Service Worker personalizado
// Deve ser carregado no HTML principal

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registrado com sucesso:', registration.scope);
        
        // Escutar atualiza√ß√µes
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          if (newWorker) {
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('üîÑ Nova vers√£o do Service Worker dispon√≠vel');
                // Opcionalmente, notificar o usu√°rio sobre a atualiza√ß√£o
              }
            });
          }
        });
      })
      .catch((error) => {
        console.error('‚ùå Erro ao registrar Service Worker:', error);
      });
  });

  // Escutar mensagens do Service Worker
  navigator.serviceWorker.addEventListener('message', (event) => {
    const { type, data } = event.data;
    
    switch (type) {
      case 'CACHE_CLEARED':
        console.log('‚úÖ Cache limpo pelo Service Worker:', data);
        break;
        
      case 'CACHE_ERROR':
        console.error('‚ùå Erro no cache do Service Worker:', data);
        break;
        
      default:
        console.log('üì® Mensagem do Service Worker:', event.data);
    }
  });
}

// Fun√ß√£o global para limpar cache via Service Worker
window.clearServiceWorkerCache = async (reason = 'manual') => {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    try {
      // Criar um MessageChannel para comunica√ß√£o bidirecional
      const messageChannel = new MessageChannel();
      
      // Prometer resposta
      const response = new Promise((resolve, reject) => {
        messageChannel.port1.onmessage = (event) => {
          if (event.data.success) {
            resolve(event.data);
          } else {
            reject(new Error(event.data.error || 'Erro desconhecido'));
          }
        };
        
        // Timeout de 10 segundos
        setTimeout(() => {
          reject(new Error('Timeout na limpeza de cache'));
        }, 10000);
      });
      
      // Enviar mensagem para o Service Worker
      navigator.serviceWorker.controller.postMessage(
        {
          type: 'CLEAR_CACHE',
          payload: { reason }
        },
        [messageChannel.port2]
      );
      
      const result = await response;
      console.log('‚úÖ Cache limpo com sucesso:', result);
      return result;
      
    } catch (error) {
      console.error('‚ùå Erro ao limpar cache via Service Worker:', error);
      throw error;
    }
  } else {
    console.warn('‚ö†Ô∏è Service Worker n√£o dispon√≠vel para limpeza de cache');
    throw new Error('Service Worker n√£o dispon√≠vel');
  }
};

// Fun√ß√£o global para obter informa√ß√µes do cache
window.getServiceWorkerCacheInfo = async () => {
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    try {
      const messageChannel = new MessageChannel();
      
      const response = new Promise((resolve, reject) => {
        messageChannel.port1.onmessage = (event) => {
          if (event.data.success) {
            resolve(event.data);
          } else {
            reject(new Error(event.data.error || 'Erro desconhecido'));
          }
        };
        
        setTimeout(() => {
          reject(new Error('Timeout ao obter informa√ß√µes do cache'));
        }, 5000);
      });
      
      navigator.serviceWorker.controller.postMessage(
        { type: 'GET_CACHE_INFO' },
        [messageChannel.port2]
      );
      
      const result = await response;
      console.log('üìä Informa√ß√µes do cache:', result);
      return result;
      
    } catch (error) {
      console.error('‚ùå Erro ao obter informa√ß√µes do cache:', error);
      throw error;
    }
  } else {
    throw new Error('Service Worker n√£o dispon√≠vel');
  }
};

console.log('üöÄ Script de registro do Service Worker carregado'); 