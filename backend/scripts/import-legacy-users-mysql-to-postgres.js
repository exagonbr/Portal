/**
 * Script para importar usu√°rios do MySQL (legado) para PostgreSQL (atual)
 * 
 * Funcionalidades:
 * - Conecta no MySQL para ler a tabela legada "user"
 * - Conecta no PostgreSQL para inserir na tabela atual "users"
 * - Converte IDs inteiros para UUIDs
 * - Armazena o ID legado no campo user_id_legacy
 * - Define todos os usu√°rios importados com role_id de TEACHER
 * - Evita duplicatas baseado no email
 * - Gera log detalhado da migra√ß√£o
 */

const mysql = require('mysql2/promise');
const knex = require('knex');
const { v4: uuidv4 } = require('uuid');
const fs = require('fs');
const bcrypt = require('bcryptjs');

// Configura√ß√µes do MySQL (legado)
let MYSQL_CONFIG;

try {
  // Tentar carregar configura√ß√£o do arquivo
  const config = require('./mysql-config.js');
  MYSQL_CONFIG = config.mysql;
  console.log('‚úÖ Configura√ß√£o MySQL carregada do arquivo mysql-config.js');
} catch (error) {
  // Fallback para vari√°veis de ambiente
  MYSQL_CONFIG = {
    host: 'sabercon.cifrllkocsxl.sa-east-1.rds.amazonaws.com',
    port: 3306,
    user: 'sabercon',
    password: 'gWg28m8^vffI9X#',
    database: 'sabercon',
    charset: 'utf8mb4'
  };
  console.log('‚ö†Ô∏è  Usando configura√ß√£o MySQL das vari√°veis de ambiente');
}

// Configura√ß√µes do PostgreSQL (atual)
const knexConfig = require('../knexfile');
const pg = knex(knexConfig.development);

// Configura√ß√µes
const TEACHER_ROLE_ID = '5b80c403-086b-414f-8501-10cff41fc6c3';
const DEFAULT_PASSWORD = 'password123'; // Senha padr√£o para usu√°rios sem senha

async function importFromMySQLToPostgreSQL() {
  let mysqlConnection = null;
  
  try {
    console.log('üöÄ Iniciando migra√ß√£o MySQL ‚Üí PostgreSQL...');
    console.log('=' .repeat(60));
    
    // Conectar ao MySQL
    console.log('üîå Conectando ao MySQL...');
    mysqlConnection = await mysql.createConnection(MYSQL_CONFIG);
    console.log('‚úÖ Conectado ao MySQL');
    
    // Verificar se a tabela PostgreSQL existe
    const pgTableExists = await pg.schema.hasTable('users');
    if (!pgTableExists) {
      console.log('‚ùå Tabela "users" n√£o encontrada no PostgreSQL.');
      console.log('   Execute as migra√ß√µes primeiro.');
      process.exit(1);
    }
    
    // Verificar se o role TEACHER existe no PostgreSQL
    const teacherRole = await pg('roles').where('id', TEACHER_ROLE_ID).first();
    if (!teacherRole) {
      console.log('‚ùå Role TEACHER n√£o encontrada no PostgreSQL.');
      console.log(`   Certifique-se de que existe um role com ID: ${TEACHER_ROLE_ID}`);
      process.exit(1);
    }
    
    console.log(`‚úÖ Role TEACHER encontrada: ${teacherRole.name}`);
    
    // Verificar se a tabela MySQL existe
    try {
      const [tables] = await mysqlConnection.execute("SHOW TABLES LIKE 'user'");
      if (tables.length === 0) {
        console.log('‚ùå Tabela "user" n√£o encontrada no MySQL.');
        process.exit(1);
      }
    } catch (error) {
      console.log('‚ùå Erro ao verificar tabela no MySQL:', error.message);
      process.exit(1);
    }
    
    // Contar registros
    const [mysqlCount] = await mysqlConnection.execute('SELECT COUNT(*) as count FROM user');
    const pgCount = await pg('users').count('id as count').first();
    
    console.log(`üìä Registros no MySQL "user": ${mysqlCount[0].count}`);
    console.log(`üìä Registros no PostgreSQL "users": ${pgCount.count}`);
    
    if (parseInt(mysqlCount[0].count) === 0) {
      console.log('‚ö†Ô∏è  Nenhum usu√°rio encontrado na tabela MySQL.');
      process.exit(0);
    }
    
    // Obter todos os usu√°rios do MySQL
    console.log('\nüì• Carregando usu√°rios do MySQL...');
    const [mysqlUsers] = await mysqlConnection.execute('SELECT * FROM user');
    
    console.log(`‚úÖ ${mysqlUsers.length} usu√°rios carregados do MySQL`);
    
    // Estat√≠sticas da migra√ß√£o
    let stats = {
      total: mysqlUsers.length,
      imported: 0,
      skipped: 0,
      errors: 0
    };
    
    // Mapeamento de IDs legados para novos UUIDs
    const idMapping = {};
    const errors = [];
    
    console.log('\nüîÑ Iniciando processo de migra√ß√£o...');
    console.log('-'.repeat(60));
    
    // Usar transa√ß√£o no PostgreSQL para garantir consist√™ncia
    await pg.transaction(async (trx) => {
      for (let i = 0; i < mysqlUsers.length; i++) {
        const mysqlUser = mysqlUsers[i];
        
        try {
          // Verificar se j√° existe um usu√°rio com este email no PostgreSQL
          const existingUser = await trx('users').where('email', mysqlUser.email).first();
          
          if (existingUser) {
            console.log(`‚è≠Ô∏è  Usu√°rio j√° existe: ${mysqlUser.email}`);
            stats.skipped++;
            continue;
          }
          
          // Verificar se j√° existe um usu√°rio com este user_id_legacy
          const existingLegacyUser = await trx('users').where('user_id_legacy', mysqlUser.id).first();
          
          if (existingLegacyUser) {
            console.log(`‚è≠Ô∏è  Usu√°rio com ID legado ${mysqlUser.id} j√° migrado`);
            stats.skipped++;
            continue;
          }
          
          // Gerar novo UUID
          const newId = uuidv4();
          idMapping[mysqlUser.id] = newId;
          
          // Preparar senha
          let hashedPassword;
          if (mysqlUser.password && mysqlUser.password.startsWith('$2')) {
            // Senha j√° est√° hasheada
            hashedPassword = mysqlUser.password;
          } else if (mysqlUser.password) {
            // Hashear senha existente
            hashedPassword = await bcrypt.hash(mysqlUser.password, 12);
          } else {
            // Usar senha padr√£o
            hashedPassword = await bcrypt.hash(DEFAULT_PASSWORD, 12);
          }
          
          // Mapear campos do MySQL para PostgreSQL
          const newUser = {
            id: newId,
            email: mysqlUser.email || `user${mysqlUser.id}@legado.com`,
            password: hashedPassword,
            name: mysqlUser.full_name || `Usu√°rio ${mysqlUser.id}`,
            cpf: mysqlUser.cpf || null,
            phone: mysqlUser.phone || mysqlUser.telefone || null,
            birth_date: mysqlUser.birth_date || mysqlUser.data_nascimento || null,
            address: mysqlUser.address || mysqlUser.endereco || null,
            city: mysqlUser.city || mysqlUser.cidade || null,
            state: mysqlUser.state || mysqlUser.estado || null,
            zip_code: mysqlUser.zip_code || mysqlUser.cep || null,
            is_active: mysqlUser.is_active !== undefined ? Boolean(mysqlUser.is_active) : 
                      mysqlUser.ativo !== undefined ? Boolean(mysqlUser.ativo) : true,
            role_id: TEACHER_ROLE_ID, // Todos como TEACHER conforme solicitado
            institution_id: mysqlUser.institution_id || null,
            school_id: mysqlUser.school_id || null,
            user_id_legacy: mysqlUser.id, // Armazenar ID legado do MySQL
            created_at: mysqlUser.created_at || mysqlUser.data_criacao || new Date(),
            updated_at: mysqlUser.updated_at || mysqlUser.data_atualizacao || new Date()
          };
          
          // Inserir o novo usu√°rio no PostgreSQL
          await trx('users').insert(newUser);
          
          stats.imported++;
          
          // Log de progresso
          if (stats.imported % 50 === 0) {
            console.log(`üìà Progresso: ${stats.imported}/${stats.total} usu√°rios migrados`);
          }
          
        } catch (error) {
          stats.errors++;
          const errorInfo = {
            mysqlId: mysqlUser.id,
            email: mysqlUser.email,
            error: error.message
          };
          errors.push(errorInfo);
          console.log(`‚ùå Erro ao migrar usu√°rio ${mysqlUser.id} (${mysqlUser.email}): ${error.message}`);
        }
      }
    });
    
    // Contar registros ap√≥s a migra√ß√£o
    const finalCount = await pg('users').count('id as count').first();
    
    // Salvar mapeamento de IDs e relat√≥rio de erros
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    
    if (Object.keys(idMapping).length > 0) {
      const mappingFile = `mysql_to_postgres_id_mapping_${timestamp}.json`;
      fs.writeFileSync(mappingFile, JSON.stringify(idMapping, null, 2));
      console.log(`üíæ Mapeamento de IDs salvo em: ${mappingFile}`);
    }
    
    if (errors.length > 0) {
      const errorsFile = `mysql_to_postgres_errors_${timestamp}.json`;
      fs.writeFileSync(errorsFile, JSON.stringify(errors, null, 2));
      console.log(`üìã Relat√≥rio de erros salvo em: ${errorsFile}`);
    }
    
    // Relat√≥rio final
    console.log('\n' + '='.repeat(60));
    console.log('üìä RELAT√ìRIO FINAL DA MIGRA√á√ÉO');
    console.log('='.repeat(60));
    console.log(`üîÑ Origem: MySQL (${MYSQL_CONFIG.host}:${MYSQL_CONFIG.port}/${MYSQL_CONFIG.database})`);
    console.log(`üéØ Destino: PostgreSQL`);
    console.log(`‚úÖ Usu√°rios migrados com sucesso: ${stats.imported}`);
    console.log(`‚è≠Ô∏è  Usu√°rios ignorados (duplicados): ${stats.skipped}`);
    console.log(`‚ùå Erros durante a migra√ß√£o: ${stats.errors}`);
    console.log(`üìà Total de usu√°rios no PostgreSQL: ${finalCount.count}`);
    console.log(`üéØ Role definida para todos: TEACHER (${TEACHER_ROLE_ID})`);
    
    if (stats.imported > 0) {
      console.log('\n‚ú® Migra√ß√£o conclu√≠da com sucesso!');
      console.log('üìù Pr√≥ximos passos recomendados:');
      console.log('   1. Verificar os usu√°rios migrados no sistema PostgreSQL');
      console.log('   2. Notificar os usu√°rios sobre suas credenciais');
      console.log('   3. Configurar institui√ß√µes e escolas se necess√°rio');
      console.log(`   4. Senha padr√£o para usu√°rios sem senha: ${DEFAULT_PASSWORD}`);
      console.log('   5. Considerar desativar acesso ao MySQL legado');
    }
    
  } catch (error) {
    console.log(`üí• Erro cr√≠tico durante a migra√ß√£o: ${error.message}`);
    console.log(error.stack);
    process.exit(1);
  } finally {
    // Fechar conex√µes
    if (mysqlConnection) {
      await mysqlConnection.end();
      console.log('üîå Conex√£o MySQL fechada');
    }
    await pg.destroy();
    console.log('üîå Conex√£o PostgreSQL fechada');
  }
}

// Executar o script
if (require.main === module) {
  importFromMySQLToPostgreSQL()
    .then(() => {
      console.log('\nüéâ Script de migra√ß√£o executado com sucesso!');
      process.exit(0);
    })
    .catch((error) => {
      console.log('\nüí• Falha na execu√ß√£o da migra√ß√£o:', error.message);
      process.exit(1);
    });
}

module.exports = { importFromMySQLToPostgreSQL }; 