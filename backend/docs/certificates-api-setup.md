# API de Certificados - Estrutura Atualizada

## Visão Geral

A API de certificados foi reformulada para refletir a estrutura da tabela `certificate` do banco de dados PostgreSQL. Esta documentação descreve a nova estrutura, endpoints e como usar a API.

## Estrutura da Tabela Certificate

```sql
CREATE TABLE public.certificate (
    id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
    "version" int8 NULL,
    date_created timestamp NOT NULL,
    last_updated timestamp NULL,
    "path" varchar(255) NULL,
    score int8 NULL,
    tv_show_id int8 NULL,
    user_id int8 NULL,
    "document" varchar(255) NULL,
    license_code varchar(255) NULL,
    tv_show_name varchar(255) NULL,
    recreate bool DEFAULT true NULL,
    CONSTRAINT certificate_pkey PRIMARY KEY (id)
);
CREATE INDEX idx_certificate_user_id ON public.certificate USING btree (user_id);
```

## Modelo de Dados

### Certificate Interface

```typescript
interface Certificate {
  id: number;
  version?: number;
  date_created: string;
  last_updated?: string;
  path?: string;
  score?: number;
  tv_show_id?: number;
  user_id?: number;
  document?: string;
  license_code?: string;
  tv_show_name?: string;
  recreate?: boolean;
}
```

## Endpoints da API

### Backend (Node.js/Express)

Base URL: `https://portal.sabercon.com.br/api/certificates`

#### GET /api/certificates
Listar certificados com filtros e paginação.

**Query Parameters:**
- `page` (number): Página atual (padrão: 1)
- `limit` (number): Itens por página (padrão: 10)
- `user_id` (number): Filtrar por ID do usuário
- `tv_show_id` (number): Filtrar por ID do programa de TV
- `score` (number): Filtrar por pontuação
- `document` (string): Filtrar por documento (busca parcial)
- `license_code` (string): Filtrar por código de licença (busca parcial)
- `tv_show_name` (string): Filtrar por nome do programa (busca parcial)
- `recreate` (boolean): Filtrar por status de recriação
- `search` (string): Busca geral em múltiplos campos
- `sort_by` (string): Campo para ordenação (`date_created`, `last_updated`, `score`, `tv_show_name`)
- `sort_order` (string): Direção da ordenação (`asc`, `desc`)

**Resposta:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "version": 1,
      "date_created": "2025-06-30T22:00:00.000Z",
      "last_updated": "2025-06-30T22:30:00.000Z",
      "path": "/certificates/cert_001.pdf",
      "score": 85,
      "tv_show_id": 1,
      "user_id": 123,
      "document": "CERT-2025-001",
      "license_code": "LIC-ABC123",
      "tv_show_name": "Programa Educativo",
      "recreate": true
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 50,
    "totalPages": 5
  }
}
```

#### GET /api/certificates/:id
Buscar certificado específico por ID.

**Resposta:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "version": 1,
    "date_created": "2025-06-30T22:00:00.000Z",
    "last_updated": "2025-06-30T22:30:00.000Z",
    "path": "/certificates/cert_001.pdf",
    "score": 85,
    "tv_show_id": 1,
    "user_id": 123,
    "document": "CERT-2025-001",
    "license_code": "LIC-ABC123",
    "tv_show_name": "Programa Educativo",
    "recreate": true
  }
}
```

#### POST /api/certificates
Criar novo certificado.

**Body:**
```json
{
  "user_id": 123,
  "tv_show_id": 1,
  "path": "/certificates/cert_002.pdf",
  "score": 90,
  "document": "CERT-2025-002",
  "license_code": "LIC-DEF456",
  "tv_show_name": "Programa Educativo 2",
  "recreate": true
}
```

**Resposta:**
```json
{
  "success": true,
  "data": {
    "id": 2,
    "version": null,
    "date_created": "2025-06-30T23:00:00.000Z",
    "last_updated": null,
    "path": "/certificates/cert_002.pdf",
    "score": 90,
    "tv_show_id": 1,
    "user_id": 123,
    "document": "CERT-2025-002",
    "license_code": "LIC-DEF456",
    "tv_show_name": "Programa Educativo 2",
    "recreate": true
  },
  "message": "Certificado criado com sucesso"
}
```

#### PUT /api/certificates/:id
Atualizar certificado existente.

**Body:**
```json
{
  "path": "/certificates/cert_001_updated.pdf",
  "score": 95,
  "document": "CERT-2025-001-UPDATED",
  "recreate": false
}
```

**Resposta:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "version": 1,
    "date_created": "2025-06-30T22:00:00.000Z",
    "last_updated": "2025-06-30T23:15:00.000Z",
    "path": "/certificates/cert_001_updated.pdf",
    "score": 95,
    "tv_show_id": 1,
    "user_id": 123,
    "document": "CERT-2025-001-UPDATED",
    "license_code": "LIC-ABC123",
    "tv_show_name": "Programa Educativo",
    "recreate": false
  },
  "message": "Certificado atualizado com sucesso"
}
```

#### DELETE /api/certificates/:id
Excluir certificado.

**Resposta:**
```json
{
  "success": true,
  "message": "Certificado excluído com sucesso",
  "data": {
    "id": 1
  }
}
```

### Frontend (Next.js API Routes)

Base URL: `/api/certificates`

Os endpoints do frontend fazem proxy para o backend, mantendo a mesma estrutura de parâmetros e respostas.

## Configuração do Banco de Dados

### Migration

Execute a migration para atualizar a estrutura da tabela:

```bash
cd backend
npm run migrate
```

### Conexão

A API utiliza PostgreSQL com a biblioteca `pg`. Configure as variáveis de ambiente:

```env
DATABASE_URL=postgresql://username:password@localhost:5432/database_name
```

## Validações

### Campos Obrigatórios
- `user_id`: Obrigatório para criação de novos certificados
- `date_created`: Preenchido automaticamente

### Validações de Dados
- `score`: Deve ser um número >= 0
- `document`: Máximo 255 caracteres
- `license_code`: Máximo 255 caracteres
- `tv_show_name`: Máximo 255 caracteres
- `path`: Máximo 255 caracteres

## Relacionamentos

### Usuários
- `user_id` referencia a tabela `users`
- Índice criado para otimizar consultas por usuário

### TV Shows
- `tv_show_id` referencia a tabela `tv_show`
- Relacionamento opcional

## Exemplos de Uso

### Buscar certificados de um usuário específico
```javascript
const response = await fetch('/api/certificates?user_id=123&sort_by=date_created&sort_order=desc');
const data = await response.json();
```

### Buscar certificados recriáveis
```javascript
const response = await fetch('/api/certificates?recreate=true');
const data = await response.json();
```

### Buscar certificados por pontuação mínima
```javascript
const response = await fetch('/api/certificates?score=80&sort_by=score&sort_order=desc');
const data = await response.json();
```

### Buscar certificados por programa de TV
```javascript
const response = await fetch('/api/certificates?tv_show_name=Programa%20Educativo');
const data = await response.json();
```

## Tratamento de Erros

### Códigos de Status HTTP
- `200`: Sucesso
- `201`: Criado com sucesso
- `400`: Dados inválidos
- `404`: Certificado não encontrado
- `500`: Erro interno do servidor

### Formato de Erro
```json
{
  "success": false,
  "message": "Descrição do erro",
  "error": "Detalhes técnicos do erro"
}
```

## Considerações de Performance

### Índices
- Índice em `user_id` para consultas por usuário
- Considere adicionar índices em `tv_show_id` e `date_created` se necessário

### Paginação
- Sempre use paginação para listas grandes
- Limite padrão de 10 itens por página
- Máximo recomendado de 100 itens por página

### Cache
- Considere implementar cache para consultas frequentes
- Use cache de resultado para listas com filtros comuns

## Segurança

### Autenticação
- Implemente autenticação JWT ou similar
- Valide permissões de usuário antes de operações

### Validação de Entrada
- Sempre valide dados de entrada
- Use prepared statements para prevenir SQL injection
- Sanitize dados antes de armazenar

### Logs
- Registre todas as operações importantes
- Monitore tentativas de acesso não autorizado