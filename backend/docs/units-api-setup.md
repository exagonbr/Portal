# Units API - Estrutura e Implementação

## Visão Geral

A API de Units foi implementada para refletir a estrutura da tabela `unit` do banco de dados PostgreSQL, seguindo o padrão estabelecido no sistema.

## Estrutura da Tabela

```sql
CREATE TABLE public.unit (
    id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
    "version" int8 NULL,
    date_created timestamp NULL,
    deleted bool NULL,
    institution_id int8 NOT NULL,
    last_updated timestamp NULL,
    "name" varchar(255) NOT NULL,
    institution_name varchar(255) NULL,
    CONSTRAINT unit_pkey PRIMARY KEY (id)
);
```

## Arquivos Implementados

### 1. Backend

#### Modelo (`backend/src/models/Unit.ts`)
- Interface TypeScript que define a estrutura da entidade Unit
- Campos obrigatórios e opcionais
- Tipos de dados corretos

#### Controlador (`backend/src/controllers/UnitsController.ts`)
- Implementa todas as operações CRUD
- Métodos disponíveis:
  - `getAll()` - Lista todas as unidades com paginação e filtros
  - `getById()` - Busca unidade por ID
  - `create()` - Cria nova unidade
  - `update()` - Atualiza unidade existente
  - `delete()` - Soft delete da unidade
  - `restore()` - Restaura unidade deletada
  - `getByInstitution()` - Lista unidades por instituição

#### Rotas (`backend/src/routes/units.ts`)
- Endpoints RESTful para todas as operações
- Middleware de autenticação aplicado
- Rotas implementadas:
  - `GET /api/units` - Listar unidades
  - `GET /api/units/search` - Buscar unidades
  - `GET /api/units/:id` - Buscar por ID
  - `POST /api/units` - Criar unidade
  - `PUT /api/units/:id` - Atualizar unidade
  - `DELETE /api/units/:id` - Deletar unidade
  - `POST /api/units/:id/restore` - Restaurar unidade
  - `GET /api/units/institution/:institutionId` - Unidades por instituição

#### Tipos de Resposta (`backend/src/types/api-responses.ts`)
- Interface `UnitResponse` atualizada com campos da tabela
- Interfaces para requisições de criação e atualização
- Helper `formatUnitResponse()` para formatação consistente

#### Migration (`backend/src/database/migrations/20250630220000_create_unit_table.js`)
- Script de migração para criar a tabela unit
- Estrutura exata conforme especificação

#### Seed (`backend/src/database/seeds/20250630220100_units_seed.js`)
- Dados de exemplo para popular a tabela
- Diferentes tipos de unidades (escola, faculdade, universidade, campus)

### 2. Frontend

#### Serviço (`src/services/unitService.ts`)
- Interface `Unit` atualizada com campos da tabela
- Métodos para todas as operações CRUD
- Tratamento de erros consistente

#### Página Admin (`src/app/admin/schools/page.tsx`)
- Interface completa para gerenciamento de unidades
- Filtros por instituição, status e tipo
- Modal para criação/edição
- Tabela responsiva com ações

## Campos da Tabela Unit

| Campo | Tipo | Obrigatório | Descrição |
|-------|------|-------------|-----------|
| `id` | BigInt | Sim | Chave primária auto-incremento |
| `version` | BigInt | Não | Controle de versão |
| `date_created` | Timestamp | Não | Data de criação |
| `deleted` | Boolean | Não | Flag de soft delete |
| `institution_id` | BigInt | Sim | ID da instituição |
| `last_updated` | Timestamp | Não | Data da última atualização |
| `name` | String(255) | Sim | Nome da unidade |
| `institution_name` | String(255) | Não | Nome da instituição (cache) |

## Campos Adicionais (Frontend)

Para compatibilidade com o frontend existente, os seguintes campos são mantidos:

- `description` - Descrição da unidade
- `type` - Tipo da unidade (school, college, university, campus)
- `active` - Status ativo (inverso do campo `deleted`)
- `created_at` - Alias para `date_created`
- `updated_at` - Alias para `last_updated`

## Funcionalidades Implementadas

### 1. CRUD Completo
- ✅ Criar unidades
- ✅ Listar unidades com paginação
- ✅ Buscar unidade por ID
- ✅ Atualizar unidades
- ✅ Soft delete de unidades
- ✅ Restaurar unidades deletadas

### 2. Filtros e Busca
- ✅ Filtro por instituição
- ✅ Filtro por status (ativo/inativo)
- ✅ Filtro por tipo
- ✅ Busca por nome
- ✅ Paginação

### 3. Validações
- ✅ Nome obrigatório (mínimo 3 caracteres)
- ✅ Instituição obrigatória
- ✅ Validação de tipos permitidos
- ✅ Verificação de existência da instituição

### 4. Interface de Usuário
- ✅ Página de administração completa
- ✅ Modal para criação/edição
- ✅ Filtros avançados
- ✅ Cards de estatísticas
- ✅ Tabela responsiva
- ✅ Ações inline (editar, deletar, ativar/desativar)

## Próximos Passos

1. **Testes**: Implementar testes unitários e de integração
2. **Validações**: Adicionar validações mais robustas no backend
3. **Auditoria**: Implementar log de auditoria para mudanças
4. **Performance**: Otimizar queries para grandes volumes de dados
5. **Relatórios**: Adicionar funcionalidades de relatórios

## Uso da API

### Listar Unidades
```bash
GET /api/units?page=1&limit=10&institution_id=1&active=true&type=school
```

### Criar Unidade
```bash
POST /api/units
Content-Type: application/json

{
  "name": "EMEF Exemplo",
  "institution_id": "1",
  "description": "Escola de exemplo",
  "type": "school"
}
```

### Atualizar Unidade
```bash
PUT /api/units/1
Content-Type: application/json

{
  "name": "EMEF Exemplo Atualizada",
  "active": true
}
```

### Deletar Unidade (Soft Delete)
```bash
DELETE /api/units/1
```

### Restaurar Unidade
```bash
POST /api/units/1/restore
```

## Observações

- Todas as operações utilizam soft delete por padrão
- O campo `institution_name` é mantido como cache para performance
- A versão é incrementada automaticamente a cada atualização
- Timestamps são gerenciados automaticamente pelo sistema